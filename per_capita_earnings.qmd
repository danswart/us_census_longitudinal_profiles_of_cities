---
title: "Per Capita Income & Earnings Analysis"
subtitle: "ACS 5-Year Estimates"
author: "Dan"
date: today
format:
  html:
    toc: true
    toc-depth: 2
    number-sections: true
    embed-resources: true
execute:
  echo: false
  warning: false
  message: false
---

```{r}
#| label: params
#| include: false

# =============================================================================
# PARAMETERS - CHANGE THESE FOR A DIFFERENT CITY/YEARS
# =============================================================================

params <- base::list(
  city       = "Schertz",
  state      = "TX",
  years      = 2012:2023,
  base_year  = 2023,
  cache_dir  = "cache/census"
)

# =============================================================================
```

```{r}
#| label: setup
#| include: false

# -----------------------------------------------------------------------------
# Package verification
# -----------------------------------------------------------------------------
required_pkgs <- c(
  "tidycensus", "tigris", "dplyr", "purrr", "tibble", "stringr", "tidyr",
  "digest", "lubridate", "quantmod", "zoo", "ggplot2", "flextable",
  "readr", "writexl"
)

missing <- required_pkgs[
  !base::vapply(required_pkgs, requireNamespace, logical(1L), quietly = TRUE)
]

if (base::length(missing) > 0L) {
  base::stop("Install missing packages:\n", base::paste(missing, collapse = ", "))
}

# -----------------------------------------------------------------------------
# Options
# -----------------------------------------------------------------------------
base::options(tigris_use_cache = TRUE)
```

```{r}
#| label: helper-functions
#| include: false

# -----------------------------------------------------------------------------
# Caching utilities
# -----------------------------------------------------------------------------

ds_cache_path <- function(cache_dir, key, ext = "rds") {
  base::dir.create(cache_dir, showWarnings = FALSE, recursive = TRUE)
  base::file.path(cache_dir, base::paste0(key, ".", ext))
}

ds_cache_key <- function(prefix, params) {
  digest::digest(base::list(prefix = prefix, params = params), algo = "xxhash64")
}

ds_cache_read <- function(path) {
  if (base::file.exists(path)) base::readRDS(path) else NULL
}

ds_cache_write <- function(x, path) {
  base::dir.create(base::dirname(path), showWarnings = FALSE, recursive = TRUE)
  base::saveRDS(x, path)
  base::invisible(x)
}

# -----------------------------------------------------------------------------
# State / Place name utilities
# -----------------------------------------------------------------------------

ds_get_state_name <- function(state_abbr) {
  fips_tbl <- tigris::fips_codes
  match_row <- fips_tbl[fips_tbl$state == state_abbr, ]
  if (base::nrow(match_row) == 0L) {
    base::warning("Unknown state abbreviation: ", state_abbr)
    return(state_abbr)
  }
  base::unique(match_row$state_name)[1L]
}

ds_place_name <- function(city, state_abbr) {
  state_full <- ds_get_state_name(state_abbr)
  base::paste0(city, " city, ", state_full)
}

# -----------------------------------------------------------------------------
# ACS data retrieval
# -----------------------------------------------------------------------------

ds_get_acs_place <- function(city, state, years, variables, survey = "acs5", cache_dir) {
  place_nm <- ds_place_name(city, state)
  
  purrr::map_dfr(years, function(y) {
    key <- ds_cache_key("acs_earnings", base::list(
      city = city, state = state, year = y, variables = variables, survey = survey
    ))
    path <- ds_cache_path(cache_dir, key)
    cached <- ds_cache_read(path)
    if (!base::is.null(cached)) return(cached)
    
    raw <- tidycensus::get_acs(
      geography   = "place",
      variables   = variables,
      year        = y,
      survey      = survey,
      state       = state,
      cache_table = TRUE
    )
    
    place_data <- raw[raw$NAME == place_nm, ]
    if (base::nrow(place_data) == 0L) {
      base::warning("No ACS data for '", place_nm, "' in year ", y)
      return(tibble::tibble())
    }
    
    out <- tibble::tibble(
      year     = y,
      variable = place_data$variable,
      estimate = place_data$estimate,
      moe      = place_data$moe
    )
    
    ds_cache_write(out, path)
  })
}

# -----------------------------------------------------------------------------
# CPI / Inflation
# -----------------------------------------------------------------------------

ds_get_cpi_annual <- function(start_year, end_year, base_year, cache_dir) {
  key <- ds_cache_key("cpi_annual", base::list(
    start_year = start_year, end_year = end_year, base_year = base_year
  ))
  path <- ds_cache_path(cache_dir, key)
  cached <- ds_cache_read(path)
  if (!base::is.null(cached)) return(cached)
  
  xt <- quantmod::getSymbols("CPIAUCSL", src = "FRED", auto.assign = FALSE)
  df <- tibble::tibble(
    date = base::as.Date(zoo::index(xt)),
    cpi  = base::as.numeric(xt[, 1L])
  )
  df$year <- lubridate::year(df$date)
  df <- df[df$year >= start_year & df$year <= end_year, ]
  
  annual <- dplyr::summarise(
    dplyr::group_by(df, year),
    cpi_annual_avg = base::mean(cpi, na.rm = TRUE),
    .groups = "drop"
  )
  
  base_cpi <- annual$cpi_annual_avg[annual$year == base_year]
  if (base::length(base_cpi) != 1L) {
    base::stop("Base year CPI not found for year ", base_year)
  }
  
  annual$base_year <- base_year
  annual$factor_to_base <- base_cpi / annual$cpi_annual_avg
  
  ds_cache_write(annual, path)
}

# -----------------------------------------------------------------------------
# Flextable styling
# -----------------------------------------------------------------------------

ds_style_flextable <- function(ft, title = NULL) {
  if (!base::is.null(title)) {
    ft <- flextable::add_header_lines(ft, values = title)
    ft <- flextable::color(ft, i = 1, part = "header", color = "blue")
    ft <- flextable::italic(ft, i = 1, part = "header")
    ft <- flextable::align(ft, i = 1, part = "header", align = "left")
    ft <- flextable::fontsize(ft, i = 1, part = "header", size = 12)
    ft <- flextable::bg(ft, i = 1, part = "header", bg = "white")
    ft <- flextable::bg(ft, i = 2, part = "header", bg = "palegreen")
  } else {
    ft <- flextable::bg(ft, i = 1, part = "header", bg = "palegreen")
  }
  ft <- flextable::autofit(ft)
  ft
}
```

# Overview

This document retrieves per capita income and earnings data for **`r params$city`, `r params$state`** from the American Community Survey (ACS) 5-year estimates.

**Variables retrieved:**

| Variable | Description |
|----------|-------------|
| B19301_001 | Per Capita Income (all ages) |
| B20017_001 | Median Earnings (workers 16+ with earnings) |
| B19013_001 | Median Household Income |

**Note:** The Census Bureau does not publish a direct "per capita earnings for adults 20+" variable. The closest proxies are:

- **Per Capita Income (B19301)**: Total income divided by total population (all ages)
- **Median Earnings (B20017)**: Median of earnings for workers 16+ who had earnings

If you need earnings specifically for the 20+ population, you would need to use PUMS microdata.


# Data Retrieval

```{r}
#| label: pull-data

# ACS variables for income/earnings
acs_vars <- c(
  per_capita_income   = "B19301_001",
  median_earnings     = "B20017_001",
  median_hh_income    = "B19013_001"
)

# Pull ACS data
acs_data <- ds_get_acs_place(
  city      = params$city,
  state     = params$state,
  years     = params$years,
  variables = base::unname(acs_vars),
  survey    = "acs5",
  cache_dir = params$cache_dir
)

# Add friendly labels
var_labels <- stats::setNames(base::names(acs_vars), acs_vars)
acs_data$variable_label <- var_labels[acs_data$variable]
```

```{r}
#| label: cpi-data

# Get CPI for inflation adjustment
cpi_tbl <- ds_get_cpi_annual(
  start_year = base::min(params$years),
  end_year   = base::max(params$years),
  base_year  = params$base_year,
  cache_dir  = params$cache_dir
)

# -----------------------------------------------------------------------------
# Create inflation rate data frame (year-over-year % change in CPI)
# This object is available in the global environment for flextable/ggplot2
# -----------------------------------------------------------------------------
inflation_rate <- cpi_tbl |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    cpi_prior = dplyr::lag(cpi_annual_avg),
    inflation_pct = (cpi_annual_avg - cpi_prior) / cpi_prior * 100
  ) |>
  dplyr::filter(!base::is.na(inflation_pct)) |>
  dplyr::select(year, cpi_annual_avg, inflation_pct)

# Join CPI to ACS data and calculate real values
acs_data <- dplyr::left_join(acs_data, cpi_tbl[, c("year", "factor_to_base")], by = "year")
acs_data$estimate_real <- acs_data$estimate * acs_data$factor_to_base
acs_data$moe_real <- acs_data$moe * acs_data$factor_to_base
```


# Annual Inflation Rate

Year-over-year percent change in CPI-U (Consumer Price Index for All Urban Consumers).

```{r}
#| label: inflation-rate-table

inflation_display <- inflation_rate |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    Year = base::as.character(year),
    `Inflation Rate` = base::paste0(base::format(base::round(inflation_pct, 1), nsmall = 1), "%")
  ) |>
  dplyr::select(Year, `Inflation Rate`)

ft_inflation <- flextable::flextable(inflation_display)
ft_inflation <- ds_style_flextable(ft_inflation, title = "Annual Inflation Rate (CPI-U)")
ft_inflation
```

```{r}
#| label: inflation-rate-chart
#| fig-width: 9
#| fig-height: 5

ggplot2::ggplot(inflation_rate, ggplot2::aes(x = year, y = inflation_pct)) +
  ggplot2::geom_col(fill = "steelblue", width = 0.7) +
  ggplot2::geom_hline(yintercept = 0, color = "black", linewidth = 0.5) +
  ggplot2::geom_text(
    ggplot2::aes(label = base::paste0(base::round(inflation_pct, 1), "%")),
    vjust = -0.5,
    size = 3
  ) +
  ggplot2::scale_x_continuous(breaks = inflation_rate$year) +
  ggplot2::scale_y_continuous(
    labels = function(x) base::paste0(x, "%"),
    expand = ggplot2::expansion(mult = c(0.05, 0.15))
  ) +
  ggplot2::labs(
    title = "Annual Inflation Rate",
    subtitle = "Year-over-year percent change in CPI-U",
    x = "Year",
    y = "Inflation Rate",
    caption = "Source: FRED CPIAUCSL (CPI for All Urban Consumers)"
  ) +
  ggplot2::theme_minimal(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    plot.title = ggplot2::element_text(face = "bold")
  )
```


# Per Capita Income

Per capita income for all ages (B19301_001).

```{r}
#| label: per-capita-table

pci <- acs_data |>
  dplyr::filter(variable_label == "per_capita_income") |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    Year = base::as.character(year),
    Nominal = base::paste0("$", base::format(base::round(estimate, 0), big.mark = ",")),
    Real = base::paste0("$", base::format(base::round(estimate_real, 0), big.mark = ",")),
    MOE = base::paste0("\u00b1$", base::format(base::round(moe, 0), big.mark = ","))
  ) |>
  dplyr::select(Year, Nominal, Real, MOE)

ft_pci <- flextable::flextable(pci)
ft_pci <- ds_style_flextable(
  ft_pci,
  title = base::paste0(
    "Per Capita Income: ", params$city, ", ", params$state,
    " (Real values in ", params$base_year, " dollars)"
  )
)
ft_pci
```

```{r}
#| label: per-capita-chart
#| fig-width: 9
#| fig-height: 5

pci_chart <- acs_data |>
  dplyr::filter(variable_label == "per_capita_income") |>
  dplyr::arrange(year)

ggplot2::ggplot(pci_chart, ggplot2::aes(x = year)) +
  ggplot2::geom_ribbon(
    ggplot2::aes(
      ymin = estimate_real - moe_real,
      ymax = estimate_real + moe_real
    ),
    fill = "lightblue",
    alpha = 0.5
  ) +
  ggplot2::geom_line(ggplot2::aes(y = estimate_real), color = "blue", linewidth = 1) +
  ggplot2::geom_point(ggplot2::aes(y = estimate_real), color = "blue", size = 2) +
  ggplot2::scale_x_continuous(breaks = pci_chart$year) +
  ggplot2::scale_y_continuous(
    labels = function(x) base::paste0("$", base::format(x, big.mark = ","))
  ) +
  ggplot2::labs(
    title = base::paste0("Per Capita Income: ", params$city, ", ", params$state),
    subtitle = base::paste0("ACS 5-Year Estimates (", params$base_year, " dollars)"),
    x = "Year",
    y = "Per Capita Income",
    caption = "Shaded area represents margin of error. Source: ACS B19301_001"
  ) +
  ggplot2::theme_minimal(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    plot.title = ggplot2::element_text(face = "bold")
  )
```


# Median Earnings (Workers 16+ with Earnings)

Median earnings for the population 16 years and over with earnings (B20017_001).

```{r}
#| label: median-earnings-table

me <- acs_data |>
  dplyr::filter(variable_label == "median_earnings") |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    Year = base::as.character(year),
    Nominal = base::paste0("$", base::format(base::round(estimate, 0), big.mark = ",")),
    Real = base::paste0("$", base::format(base::round(estimate_real, 0), big.mark = ",")),
    MOE = base::paste0("\u00b1$", base::format(base::round(moe, 0), big.mark = ","))
  ) |>
  dplyr::select(Year, Nominal, Real, MOE)

ft_me <- flextable::flextable(me)
ft_me <- ds_style_flextable(
  ft_me,
  title = base::paste0(
    "Median Earnings (Workers 16+): ", params$city, ", ", params$state,
    " (Real values in ", params$base_year, " dollars)"
  )
)
ft_me
```

```{r}
#| label: median-earnings-chart
#| fig-width: 9
#| fig-height: 5

me_chart <- acs_data |>
  dplyr::filter(variable_label == "median_earnings") |>
  dplyr::arrange(year)

ggplot2::ggplot(me_chart, ggplot2::aes(x = year)) +
  ggplot2::geom_ribbon(
    ggplot2::aes(
      ymin = estimate_real - moe_real,
      ymax = estimate_real + moe_real
    ),
    fill = "lightgreen",
    alpha = 0.5
  ) +
  ggplot2::geom_line(ggplot2::aes(y = estimate_real), color = "darkgreen", linewidth = 1) +
  ggplot2::geom_point(ggplot2::aes(y = estimate_real), color = "darkgreen", size = 2) +
  ggplot2::scale_x_continuous(breaks = me_chart$year) +
  ggplot2::scale_y_continuous(
    labels = function(x) base::paste0("$", base::format(x, big.mark = ","))
  ) +
  ggplot2::labs(
    title = base::paste0("Median Earnings: ", params$city, ", ", params$state),
    subtitle = base::paste0("Workers 16+ with Earnings, ACS 5-Year (", params$base_year, " dollars)"),
    x = "Year",
    y = "Median Earnings",
    caption = "Shaded area represents margin of error. Source: ACS B20017_001"
  ) +
  ggplot2::theme_minimal(base_size = 12) +
  ggplot2::theme(
    axis.text.x = ggplot2::element_text(angle = 45, hjust = 1),
    plot.title = ggplot2::element_text(face = "bold")
  )
```


# Median Household Income

Median household income (B19013_001) for reference.

```{r}
#| label: median-hh-income-table

mhi <- acs_data |>
  dplyr::filter(variable_label == "median_hh_income") |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    Year = base::as.character(year),
    Nominal = base::paste0("$", base::format(base::round(estimate, 0), big.mark = ",")),
    Real = base::paste0("$", base::format(base::round(estimate_real, 0), big.mark = ",")),
    MOE = base::paste0("\u00b1$", base::format(base::round(moe, 0), big.mark = ","))
  ) |>
  dplyr::select(Year, Nominal, Real, MOE)

ft_mhi <- flextable::flextable(mhi)
ft_mhi <- ds_style_flextable(
  ft_mhi,
  title = base::paste0(
    "Median Household Income: ", params$city, ", ", params$state,
    " (Real values in ", params$base_year, " dollars)"
  )
)
ft_mhi
```


# Summary Comparison

All three measures side-by-side (inflation-adjusted to `r params$base_year` dollars).

```{r}
#| label: comparison-table

comparison <- acs_data |>
  dplyr::select(year, variable_label, estimate_real) |>
  tidyr::pivot_wider(
    names_from = variable_label,
    values_from = estimate_real
  ) |>
  dplyr::arrange(year) |>
  dplyr::mutate(
    Year = base::as.character(year),
    `Per Capita Income` = base::paste0(
      "$", base::format(base::round(per_capita_income, 0), big.mark = ",")
    ),
    `Median Earnings` = base::paste0(
      "$", base::format(base::round(median_earnings, 0), big.mark = ",")
    ),
    `Median HH Income` = base::paste0(
      "$", base::format(base::round(median_hh_income, 0), big.mark = ",")
    )
  ) |>
  dplyr::select(Year, `Per Capita Income`, `Median Earnings`, `Median HH Income`)

ft_comp <- flextable::flextable(comparison)
ft_comp <- ds_style_flextable(
  ft_comp,
  title = base::paste0(
    "Income & Earnings Comparison: ", params$city, ", ", params$state,
    " (", params$base_year, " dollars)"
  )
)
ft_comp
```


# CPI Inflation Factors

Reference table showing CPI-U annual averages used for inflation adjustment.

```{r}
#| label: cpi-table

cpi_display <- cpi_tbl |>
  dplyr::mutate(
    Year = base::as.character(year),
    `CPI-U Avg` = base::round(cpi_annual_avg, 2),
    `Base Year` = base::as.character(base_year),
    Factor = base::round(factor_to_base, 4)
  ) |>
  dplyr::select(Year, `CPI-U Avg`, `Base Year`, Factor)

ft_cpi <- flextable::flextable(cpi_display)
ft_cpi <- ds_style_flextable(
  ft_cpi,
  title = base::paste0("CPI-U Inflation Factors (Base: ", params$base_year, ")")
)
ft_cpi
```


# Export Data

```{r}
#| label: export-data

# Create output directory
base::dir.create("out", showWarnings = FALSE, recursive = TRUE)

# Prepare clean export data
export_data <- acs_data |>
  dplyr::select(
    year,
    variable,
    variable_label,
    estimate_nominal = estimate,
    moe_nominal = moe,
    estimate_real,
    moe_real,
    cpi_factor = factor_to_base
  ) |>
  dplyr::arrange(variable_label, year)

# File name base
file_base <- base::paste0(
  "out/",
  base::tolower(base::gsub(" ", "_", params$city)),
  "_",
  params$state,
  "_earnings_income_",
  base::min(params$years),
  "_",
  base::max(params$years)
)

# Save as RDS
base::saveRDS(export_data, base::paste0(file_base, ".rds"))

# Save inflation_rate as separate RDS for easy reuse
base::saveRDS(inflation_rate, base::paste0(file_base, "_inflation_rate.rds"))

# Save as CSV
readr::write_csv(export_data, base::paste0(file_base, ".csv"))
readr::write_csv(inflation_rate, base::paste0(file_base, "_inflation_rate.csv"))

# Save as Excel (3 sheets)
writexl::write_xlsx(
  base::list(
    earnings_income = export_data,
    inflation_rate = inflation_rate,
    cpi_factors = cpi_tbl
  ),
  base::paste0(file_base, ".xlsx")
)
```

Data exported to `out/` directory:

- **RDS**: `r base::paste0(file_base, ".rds")` — Income/earnings data
- **RDS**: `r base::paste0(file_base, "_inflation_rate.rds")` — Inflation rate data
- **CSV**: `r base::paste0(file_base, ".csv")` — Income/earnings data
- **CSV**: `r base::paste0(file_base, "_inflation_rate.csv")` — Inflation rate data
- **Excel**: `r base::paste0(file_base, ".xlsx")` — Three sheets: earnings_income, inflation_rate, cpi_factors


# Using This Template

To analyze a different city, change these values in the `params` code chunk:

```r
params <- base::list(
  city       = "Austin",
  state      = "TX",
  years      = 2012:2023,
  base_year  = 2023,
  cache_dir  = "cache/census"
)
```

Clear cache when switching cities:

```r
unlink("cache", recursive = TRUE)
```


# Notes

- **Per Capita Income (B19301)**: Total income of all residents divided by total population. Includes all ages and all income types (wages, investments, transfers, etc.).

- **Median Earnings (B20017)**: Median of earnings for workers 16+ who had earnings in the past 12 months. Only includes wage/salary income and self-employment income.

- **ACS 5-Year Estimates**: End-year labels (e.g., 2023 = 2019-2023 data). More reliable for small geographies but reflects a 5-year period, not a single point in time.

- **For Adults 20+ Specifically**: You would need PUMS microdata to filter to exactly 20+ population. The B20017 variable covers 16+, and B19301 covers all ages.

- **Caching**: All API calls are cached to RDS files in the `cache/census` directory to minimize traffic. Clear with `unlink("cache", recursive = TRUE)`.


# Export Data

```{r}
#| label: export

# Create output directory
base::dir.create("out", showWarnings = FALSE, recursive = TRUE)

# Prepare export data
export_data <- acs_data |>
  dplyr::select(
    year,
    variable,
    variable_label,
    estimate_nominal = estimate,
    moe_nominal = moe,
    estimate_real,
    moe_real,
    cpi_factor = factor_to_base
  ) |>
  dplyr::arrange(variable_label, year)

# File paths
file_base <- base::paste0(
  "out/",
  base::tolower(base::gsub(" ", "_", params$city)),
  "_",
  params$state,
  "_income_earnings_",
  base::min(params$years),
  "_",
  base::max(params$years)
)

# Save as RDS
base::saveRDS(export_data, base::paste0(file_base, ".rds"))

# Save as CSV
readr::write_csv(export_data, base::paste0(file_base, ".csv"))

# Save as Excel
writexl::write_xlsx(
  base::list(
    income_earnings = export_data,
    cpi_factors = cpi_tbl
  ),
  base::paste0(file_base, ".xlsx")
)
```

Data exported to `out/` directory:

- **RDS**: `r base::paste0(file_base, ".rds")` — R native format, preserves all data types
- **CSV**: `r base::paste0(file_base, ".csv")` — Universal format
- **Excel**: `r base::paste0(file_base, ".xlsx")` — Two sheets: income_earnings + cpi_factors
